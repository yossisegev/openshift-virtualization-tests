# description: Add comment for CodeRabbit to add tests instructions. A change-request comment will be added to the PR.

name: Request CodeRabbit tests instructions

on:
  pull_request_target:
    types: [labeled]

permissions:
  pull-requests: write
  contents: read

jobs:
  comment-on-commit:
    if: |
      github.event.label.name == 'verified' &&
      !contains(github.event.pull_request.user.login, 'renovate')
    runs-on: ubuntu-latest

    steps:
      - name: Check team membership
        id: check-user-team
        uses: tspascoal/get-user-teams-membership@v3
        with:
          team: cnvqe-bot
          username: ${{ github.event.pull_request.user.login }}
          GITHUB_TOKEN: ${{ secrets.BOT3_TOKEN }}

      - name: Create or update comment
        if: steps.check-user-team.outputs.is-member != 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.BOT3_TOKEN }}
          body: |
            @coderabbitai
            <details>
              <summary>Test execution plan request details</summary>

              CRITICAL: You MUST respond with a review comment on the Files Changed tab, NOT as a regular PR comment.
              If it cannot be on the 1st line of the 1st file, add it to any other changed file.

              As an expert software testing engineer, analyze all modified files in this PR and create a targeted test execution plan.
              You will create a change request comment on the 1st line of the 1st file in the pr with the test execution plan.
              If you fail to run or post a comment, retry.

              **Analysis Requirements:**

              1. Examine code changes in each modified file
              2. Identify affected code paths, functions, and classes
              3. Analyze pytest-specific elements: fixtures (scope, dependencies), parametrization, markers, conftest changes
              4. Trace test dependencies through imports, shared utilities, and fixture inheritance
              5. Detect new tests introduced in the PR
              6. **Smoke Test Impact Analysis:** Determine if any changes could affect smoke tests by checking:
                 - Changes to files/functions used by tests marked with `@pytest.mark.smoke`
                 - Changes to fixtures or utilities imported by smoke tests
                 - Changes to conftest.py files that may affect smoke test execution
                 - Changes to core infrastructure code (utilities/, libs/) that smoke tests depend on

              **Your deliverable:**
              Your change request comment will be based on the following requirements:

              **Test Execution Plan**

              - **Run smoke tests: True / False** _(Based on your smoke test impact analysis - True if any changes may affect smoke tests)_
              - `path/to/test_file.py` - When the entire test file needs verification
              - `path/to/test_file.py::TestClass::test_method` - When specific test(s) needed
              - `path/to/test_file.py::test_function` - When specific test(s) needed
              - `-m marker` - When specific marker(s) can be used to cover multiple cases.

              **Guidelines:**

              - Include only tests directly affected by the changes
              - Use a full file path only if ALL tests in that file require verification
              - Use file path + test name if only specific tests are needed
              - If a test marker can cover multiple files/tests, provide the marker
              - Balance coverage vs over-testing - Keep descriptions minimal

              When responding to test execution plan request:
                - Post ONLY an inline review comment on the Files Changed tab with the test plan
                - ONLY! if you fail to add a review comment, add a comment in the PR discussion thread
                - Do NOT add any follow-up comments in the PR discussion thread
                - Do not add a follow-up comment in the PR
                - Do NOT add acknowledgment comments like "I've successfully posted..."
                - After posting the review comment, consider the task complete and do not generate any additional replies

              CRITICAL: Before setting "Run smoke tests: True", you MUST use shell scripts to:
                - Trace the actual fixture dependency chain from smoke tests to changed fixtures
                - Verify that smoke tests actually import/use changed utilities or functions
                - Confirm the dependency path exists; do NOT assume based on scope or semantics
                - Be conservative: Session-scoped fixtures or infrastructure-sounding names do NOT
                  automatically mean smoke test impact. Only flag smoke test impact when you can
                  demonstrate a concrete dependency path.
                WRONG: "This session-scoped storage fixture might affect smoke tests"
                RIGHT: "Smoke test X uses fixture Y, which depends on the changed fixture Z"

            </details>
