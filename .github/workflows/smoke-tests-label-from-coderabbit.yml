# Smoke Tests Label Manager - Automatically adds/removes 'smoke-tests:pending' label based on CodeRabbit analysis
# Created with Claude Code assistance
#
# Summary:
# ┌──────────────────────────────────────────────────────────────┬───────────────────────┬──────────────────────────────┐
# │ CodeRabbit Comment Contains                                  │ Current Label         │ Action                       │
# ├──────────────────────────────────────────────────────────────┼───────────────────────┼──────────────────────────────┤
# │ "Run smoke tests: True" AND "Test Execution Plan"           │ None                  │ ✅ Add 'smoke-tests:pending' │
# │ "Run smoke tests: True" AND "Test Execution Plan"           │ Already has label     │ ✅ No-op (safe)              │
# │ "Run smoke tests: False" AND "Test Execution Plan"          │ Has label             │ ✅ Remove label              │
# │ "Run smoke tests: False" AND "Test Execution Plan"          │ None                  │ ✅ No action                 │
# │ Missing "Test Execution Plan"                                │ Any                   │ ⏭️ No action                 │
# │ Neither pattern                                              │ Any                   │ ⏭️ No action                 │
# │ Comment not from CodeRabbit                                  │ Any                   │ ⏭️ Does NOT run              │
# └──────────────────────────────────────────────────────────────┴───────────────────────┴──────────────────────────────┘

name: "Smoke Tests Label from CodeRabbit"

on:
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  manage-smoke-tests-label:
    name: Manage smoke-tests:pending label
    # Only run for CodeRabbit comments
    if: |
      github.event.comment.user.login == 'coderabbitai' ||
      github.event.comment.user.login == 'coderabbitai[bot]' ||
      contains(github.event.comment.user.login, 'coderabbit')
    runs-on: ubuntu-latest

    steps:
      - name: Debug - Log comment information
        run: |
          echo "=========================================="
          echo "Comment Debug Information"
          echo "=========================================="
          echo "Comment Author: ${{ github.event.comment.user.login }}"
          echo ""
          echo "Comment Body (first 100 chars):"
          echo "${{ github.event.comment.body }}" | head -c 100
          echo ""
          echo "=========================================="
          echo "Condition Matching Results"
          echo "=========================================="
          echo "Contains 'Test Execution Plan'? ${{ contains(github.event.comment.body, 'Test Execution Plan') }}"
          echo "Contains 'Run smoke tests: True'? ${{ contains(github.event.comment.body, 'Run smoke tests: True') }}"
          echo "Contains 'Run smoke tests: False'? ${{ contains(github.event.comment.body, 'Run smoke tests: False') }}"
          echo ""
          echo "=========================================="
          echo "Action Determination"
          echo "=========================================="
          HAS_TEST_PLAN="${{ contains(github.event.comment.body, 'Test Execution Plan') }}"
          HAS_RUN_TRUE="${{ contains(github.event.comment.body, 'Run smoke tests: True') }}"
          HAS_RUN_FALSE="${{ contains(github.event.comment.body, 'Run smoke tests: False') }}"

          if [ "$HAS_TEST_PLAN" = "true" ] && [ "$HAS_RUN_TRUE" = "true" ]; then
            echo "ACTION: ✅ Will ADD smoke-tests:pending label"
          elif [ "$HAS_TEST_PLAN" = "true" ] && [ "$HAS_RUN_FALSE" = "true" ]; then
            echo "ACTION: ✅ Will REMOVE smoke-tests:pending label"
          else
            echo "ACTION: ⏭️ No label change (missing Test Execution Plan or smoke test directive)"
          fi
          echo "=========================================="

      - name: Add smoke-tests:pending label
        if: "contains(github.event.comment.body, 'Run smoke tests: True') && contains(github.event.comment.body, 'Test Execution Plan')"
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: smoke-tests:pending
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove smoke-tests:pending label
        if: "contains(github.event.comment.body, 'Run smoke tests: False') && contains(github.event.comment.body, 'Test Execution Plan')"
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true  # Ignore error if label doesn't exist
        with:
          labels: smoke-tests:pending
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: No action needed
        if: |
          !contains(github.event.comment.body, 'Test Execution Plan') ||
          (!contains(github.event.comment.body, 'Run smoke tests: True') && !contains(github.event.comment.body, 'Run smoke tests: False'))
        run: echo "⏭️ No action needed - comment does not contain smoke test directive or Test Execution Plan"
