# Smoke Tests Label Manager - Automatically adds/removes 'smoke-tests:pending-analysis' label based on CodeRabbit analysis
# Created with Claude Code assistance
#
# Summary:
# ┌──────────────────────────────────────────────────────────────┬───────────────────────────────┬────────────────────────────────────────┐
# │ CodeRabbit Comment Contains                                  │ Current Label                 │ Action                                 │
# ├──────────────────────────────────────────────────────────────┼───────────────────────────────┼────────────────────────────────────────┤
# │ "Run smoke tests: True" AND "**Test Execution Plan**"       │ None                          │ ✅ Add 'smoke-tests:pending-analysis'  │
# │ "Run smoke tests: True" AND "**Test Execution Plan**"       │ Already has label             │ ✅ No-op (safe)                        │
# │ "Run smoke tests: False" AND "**Test Execution Plan**"      │ Has label                     │ ✅ Remove label                        │
# │ "Run smoke tests: False" AND "**Test Execution Plan**"      │ None                          │ ✅ No action                           │
# │ New commit pushed (PR opened/sync/reopened)                 │ Has label                     │ ✅ Remove label                        │
# │ Missing "**Test Execution Plan**"                            │ Any                           │ ⏭️ No action                           │
# │ Neither pattern                                              │ Any                           │ ⏭️ No action                           │
# │ Comment not from CodeRabbit                                  │ Any                           │ ⏭️ Does NOT run                        │
# └──────────────────────────────────────────────────────────────┴───────────────────────────────┴────────────────────────────────────────┘

name: "Smoke Tests Label from CodeRabbit"

on:
  # WARNING: pull_request_target runs with write permissions on base repo
  # Safe here because we only manipulate labels without executing PR code
  # NEVER add steps that checkout or execute code from the PR branch
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  reset-on-push:
    name: Reset label on new commit
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest

    steps:
      - name: Debug - Log push event
        run: |
          echo ""
          echo "ACTION: Removing smoke-tests:pending-analysis label (if exists)"
          echo "=========================================="

      - name: Remove smoke-tests:pending-analysis label
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.pull_request.number }}
          labels: smoke-tests:pending-analysis
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Completion message
        run: echo "✅ Label removed (if it existed) - waiting for new CodeRabbit analysis"

  manage-smoke-tests-label:
    name: Manage smoke-tests:pending-analysis label
    # Only run for CodeRabbit comments
    if: |
      github.event_name != 'pull_request_target' &&
      github.event.comment != null &&
      (github.event.comment.user.login == 'coderabbitai' || github.event.comment.user.login == 'coderabbitai[bot]')
    runs-on: ubuntu-latest

    steps:
      - name: Debug - Log comment information
        run: |
          echo "=========================================="
          echo "Comment Debug Information"
          echo "=========================================="
          echo "Comment Author: ${{ github.event.comment.user.login }}"
          echo "=========================================="
          echo "Condition Matching Results"
          echo "=========================================="
          echo "Contains '**Test Execution Plan**'? ${{ contains(github.event.comment.body, '**Test Execution Plan**') }}"
          echo "Contains 'Run smoke tests: True'? ${{ contains(github.event.comment.body, 'Run smoke tests: True') }}"
          echo "Contains 'Run smoke tests: False'? ${{ contains(github.event.comment.body, 'Run smoke tests: False') }}"
          echo ""
          echo "=========================================="

      - name: Add smoke-tests:pending-analysis label
        if: "contains(github.event.comment.body, 'Run smoke tests: True') && contains(github.event.comment.body, '**Test Execution Plan**')"
        uses: actions-ecosystem/action-add-labels@v1
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: smoke-tests:pending-analysis
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove smoke-tests:pending-analysis label
        if: "contains(github.event.comment.body, 'Run smoke tests: False') && contains(github.event.comment.body, '**Test Execution Plan**')"
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: smoke-tests:pending-analysis
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: No action needed
        if: |
          !contains(github.event.comment.body, '**Test Execution Plan**') ||
          (!contains(github.event.comment.body, 'Run smoke tests: True') && !contains(github.event.comment.body, 'Run smoke tests: False'))
        run: echo "⏭️ No action needed - comment does not contain smoke test directive or **Test Execution Plan**"
